---
title: "Onramp Flow (Fiat → Crypto)"
description: "This document shows the complete onramp flow for converting fiat to crypto, including payment collection and crypto delivery."
---

**Available Countries**: South Africa, Ivory Coast, Benin, Congo B, Gabon, Burkina Faso, Malawi, Mozambique, Senegal, Sierra Leone, Zambia

---

## 1. Transaction Initiation

Creating an onramp transaction with rate locking.

```mermaid
sequenceDiagram
    participant User
    participant API
    participant OnrampService

    User->>API: POST /onramp/crypto
    API->>API: Validate API Key
    API->>OnrampService: Create Onramp

    OnrampService->>OnrampService: Generate Transaction ID
    OnrampService->>OnrampService: Lock Exchange Rate (Fiat→Crypto)
    OnrampService->>OnrampService: Calculate Crypto Amount & Fees

    alt Has Crypto Wallet
        OnrampService->>OnrampService: Validate Wallet Address
        OnrampService->>OnrampService: Mode: CRYPTO_DELIVERY
    else No Crypto Wallet
        OnrampService->>OnrampService: Mode: FIAT_WALLET_CREDIT
    end

    OnrampService-->>API: Transaction Details
    API-->>User: Transaction ID & Payment Instructions
```

---

## 2. Fiat Payment Collection

### Mobile Money Payment

```mermaid
sequenceDiagram
    participant User
    participant OnrampService
    participant DepositService
    participant Provider as Mobile Money Provider

    OnrampService->>DepositService: Initiate Fiat Deposit
    DepositService->>Provider: Initiate Collection
    Provider-->>DepositService: STK Push Sent
    DepositService->>DepositService: Status: PENDING_PROVIDER
    DepositService-->>User: STK Push / USSD Instructions

    User->>Provider: Enter PIN / Confirm Payment
    Provider->>DepositService: Payment Callback
    DepositService->>OnrampService: Payment Confirmed
    OnrampService->>OnrampService: Status: CRYPTO_PENDING
```

**Available Countries**: All supported countries
**Networks**: M-PESA, MTN Money, Airtel Money, Orange Money

### Bank Checkout Payment

```mermaid
sequenceDiagram
    participant User
    participant OnrampService
    participant DepositService
    participant Provider as Bank Provider

    OnrampService->>DepositService: Initiate Bank Deposit
    DepositService->>Provider: Create Checkout Session
    Provider-->>DepositService: Checkout URL
    DepositService-->>OnrampService: Checkout URL
    OnrampService-->>User: Redirect to Bank Portal

    User->>Provider: Complete Bank Payment
    Provider->>DepositService: Payment Webhook
    DepositService->>OnrampService: Payment Confirmed
    OnrampService->>OnrampService: Status: CRYPTO_PENDING
```

### Fiat Wallet Deduction

```mermaid
sequenceDiagram
    participant User
    participant OnrampService
    participant CryptoWallet

    OnrampService->>CryptoWallet: Check Fiat Balance
    alt Insufficient Balance
        CryptoWallet-->>User: 400 Insufficient Funds
    else Sufficient Balance
        CryptoWallet->>CryptoWallet: Reserve Fiat Amount
        OnrampService->>OnrampService: Status: CRYPTO_PENDING
    end
```

---

## 3. Crypto Delivery

### Lightning Network Delivery

```mermaid
sequenceDiagram
    participant OnrampService
    participant Blockchain as Lightning Network
    participant CryptoWallet

    OnrampService->>OnrampService: Validate Lightning Invoice
    OnrampService->>Blockchain: Pay Lightning Invoice
    Blockchain-->>OnrampService: Payment Preimage

    alt Payment Success
        OnrampService->>OnrampService: Status: SUCCESS
        OnrampService->>CryptoWallet: Deduct Fiat
    else Payment Failed
        OnrampService->>OnrampService: Status: FAILED
        OnrampService->>CryptoWallet: Credit Fiat Wallet (Refund)
    end
```

### EVM Chain Delivery

```mermaid
sequenceDiagram
    participant OnrampService
    participant Blockchain as EVM Chain
    participant CryptoWallet

    OnrampService->>OnrampService: Validate EVM Address
    OnrampService->>Blockchain: Initiate Token Transfer
    Blockchain-->>OnrampService: Transaction Hash
    OnrampService->>OnrampService: Status: PROCESSING

    loop Monitor Confirmations (3+ blocks)
        OnrampService->>Blockchain: Check Status
        alt Confirmed
            Blockchain-->>OnrampService: Confirmed
            OnrampService->>OnrampService: Status: SUCCESS
            OnrampService->>CryptoWallet: Deduct Fiat
        else Failed
            OnrampService->>OnrampService: Retry (Max 3)
            alt Max Retries
                OnrampService->>OnrampService: Status: FAILED
                OnrampService->>CryptoWallet: Refund to Fiat Wallet
            end
        end
    end
```

**Supported Networks**: Ethereum, Polygon, Arbitrum, Base, Optimism
**Tokens**: USDT, USDC, DAI

### TRON Network Delivery

```mermaid
sequenceDiagram
    participant OnrampService
    participant Blockchain as TRON
    participant CryptoWallet

    OnrampService->>OnrampService: Validate TRON Address
    OnrampService->>Blockchain: Initiate TRC20 Transfer
    Blockchain-->>OnrampService: Transaction Hash
    OnrampService->>OnrampService: Status: PROCESSING

    loop Monitor TronGrid
        OnrampService->>Blockchain: Check Confirmation
        alt Confirmed
            OnrampService->>OnrampService: Status: SUCCESS
            OnrampService->>CryptoWallet: Deduct Fiat
        else Failed
            OnrampService->>OnrampService: Status: FAILED
            OnrampService->>CryptoWallet: Refund to Fiat Wallet
        end
    end
```

**Tokens**: USDT (TRC20)

### Fiat Wallet Credit (No Crypto Wallet)

```mermaid
sequenceDiagram
    participant OnrampService
    participant CryptoWallet

    Note over OnrampService: No crypto wallet provided
    OnrampService->>CryptoWallet: Credit Fiat Wallet
    OnrampService->>OnrampService: Status: SUCCESS
    Note over OnrampService: Credited at crypto rate
```

---

## 4. Webhook Notification

```mermaid
sequenceDiagram
    participant OnrampService
    participant Queue
    participant Integrator

    OnrampService->>Queue: Queue Callback Job
    Queue->>Integrator: POST Webhook (Signed)

    alt Webhook Success
        Integrator-->>Queue: 200 OK
        Queue->>OnrampService: CALLBACK_SENT
    else Webhook Failed
        Queue->>Queue: Retry 3x with Backoff
        alt Retries Exhausted
            Queue->>Queue: Cron Retry (Every 2h, Max 24h)
        end
    end
```

---

## Transaction Statuses

| Status | Description |
|--------|-------------|
| `PENDING` | Awaiting fiat payment |
| `PENDING_PROVIDER` | Payment initiated with provider |
| `CRYPTO_PENDING` | Fiat confirmed, crypto transfer in progress |
| `PROCESSING` | Blockchain transaction submitted |
| `SUCCESS` | Crypto delivered successfully |
| `FAILED` | Transaction failed (fiat refunded to wallet) |
| `TIMEOUT` | Payment not confirmed within 24 hours |

---

## Key Features

### Rate Locking
- Exchange rate locked at transaction creation
- Valid for 30 minutes
- Auto-refreshed upon payment confirmation

### Flexible Delivery
- **Has Crypto Wallet**: Crypto delivered to user's address
- **No Crypto Wallet**: Fiat credited at crypto rate

### Safety Mechanisms
- Failed crypto transfers automatically refund to fiat wallet
- Up to 3 retry attempts for blockchain transactions
- Balance never lost

---

## Error Handling

### Insufficient Fiat Wallet Balance
```json
{
  "statusCode": 400,
  "message": "Insufficient balance in fiat wallet"
}
```

### Invalid Crypto Address
```json
{
  "statusCode": 400,
  "message": "Invalid crypto address"
}
```

### Crypto Transfer Failed (Auto-Refund)
```json
{
  "status": "FAILED",
  "message": "Crypto transfer failed after 3 attempts",
  "refund": {
    "amount": 10000,
    "currency": "KES",
    "destination": "Fiat Wallet",
    "status": "REFUNDED"
  }
}
```

---

## Best Practices

- **Pre-Check Rates**: Use `/rates/onramp-rate` before creating transaction
- **Validate Addresses**: Verify address format matches network
- **Handle Callbacks**: Implement webhook endpoint with HMAC verification
- **Monitor Status**: Poll status endpoint and display transaction hash to users

---

## Testing

Use sandbox mode with test credentials provided in sandbox documentation.
