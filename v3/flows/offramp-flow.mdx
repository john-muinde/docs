---
title: "Offramp Flow"
description: "Complete sequence diagrams for offramp transactions (Crypto → Fiat)"
---

# Offramp Flow (Sell Crypto)

This document shows the complete offramp flow for converting crypto to fiat and disbursing to users via different payment methods.

**Key Features**:
- Rate locking (60 seconds validity)
- Two flow modes: External wallet or Integrated wallet
- Automatic refunds on fiat transfer failure
- Multi-network crypto support (EVM, TRON, Lightning, Stellar)

---

## 1. Transaction Initiation & Rate Locking

```mermaid
sequenceDiagram
    participant User
    participant API
    participant OfframpService
    participant RateService

    User->>API: POST /offramp
    API->>API: Validate API Key
    API->>OfframpService: Create Offramp

    OfframpService->>OfframpService: Validate Request
    OfframpService->>OfframpService: Check Duplicate

    alt Has Rate ID
        OfframpService->>RateService: Validate Rate (60s expiry)
        alt Rate Expired
            RateService-->>User: 400 Rate Expired
        else Rate Valid
            RateService-->>OfframpService: Rate Valid
        end
    end

    OfframpService->>OfframpService: Lock Exchange Rate (Crypto→Fiat)
    OfframpService->>OfframpService: Calculate Fiat Amount & Fees
```

---

## 2. Crypto Receipt

### External Wallet Flow

User sends crypto from their own wallet.

```mermaid
sequenceDiagram
    participant User
    participant OfframpService
    participant Blockchain

    OfframpService->>OfframpService: Generate Deposit Address
    OfframpService->>OfframpService: Status: PENDING
    OfframpService-->>User: Send Crypto to Address

    User->>Blockchain: Transfer Crypto
    Blockchain->>OfframpService: Transaction Detected

    loop Monitor Confirmations (3+ blocks)
        OfframpService->>Blockchain: Check Confirmation Count
        alt Confirmed
            Blockchain-->>OfframpService: Confirmed
            OfframpService->>OfframpService: Status: CRYPTO_RECEIVED
        else Failed/Timeout
            Blockchain-->>OfframpService: Failed
            OfframpService->>OfframpService: Status: FAILED
        end
    end
```

### Integrated Wallet Flow

Platform wallet holds crypto, instant processing.

```mermaid
sequenceDiagram
    participant OfframpService
    participant Blockchain

    OfframpService->>OfframpService: Verify Wallet Ownership
    OfframpService->>Blockchain: Deduct Crypto from Wallet
    OfframpService->>OfframpService: Status: CRYPTO_RECEIVED
    Note over OfframpService: Crypto already in platform custody
```

---

## 3. Fiat Disbursement

### Mobile Money Disbursement

```mermaid
sequenceDiagram
    participant OfframpService
    participant WithdrawService
    participant Provider as Mobile Money Provider

    OfframpService->>WithdrawService: Initiate Mobile Money Withdrawal
    WithdrawService->>WithdrawService: Validate Phone & Network
    WithdrawService->>Provider: Initiate Disbursement

    alt Disbursement Success
        Provider-->>WithdrawService: Payment Sent
        WithdrawService->>WithdrawService: Status: SUCCESS
        WithdrawService-->>OfframpService: Fiat Delivered
        OfframpService->>OfframpService: Status: SUCCESS
    else Disbursement Failed
        Provider-->>WithdrawService: Payment Failed
        WithdrawService-->>OfframpService: Fiat Failed
        OfframpService->>OfframpService: Status: REFUND_PENDING
    end
```

**Available Countries**: All supported countries
**Networks**: M-PESA, Airtel Money, MTN Mobile Money, Orange Money

### Bank Transfer Disbursement

```mermaid
sequenceDiagram
    participant OfframpService
    participant WithdrawService
    participant Provider as Bank Provider

    OfframpService->>WithdrawService: Initiate Bank Transfer
    WithdrawService->>WithdrawService: Validate Bank Details
    WithdrawService->>WithdrawService: Verify Account Number
    WithdrawService->>Provider: Initiate Bank Transfer

    alt Transfer Success
        Provider-->>WithdrawService: Transfer Complete
        WithdrawService->>WithdrawService: Status: SUCCESS
        WithdrawService-->>OfframpService: Fiat Delivered
        OfframpService->>OfframpService: Status: SUCCESS
    else Transfer Failed
        Provider-->>WithdrawService: Transfer Failed
        WithdrawService-->>OfframpService: Fiat Failed
        OfframpService->>OfframpService: Status: REFUND_PENDING
    end
```

**Available Countries**: All supported countries
**Processing Time**: Instant to 24 hours

---

## 4. Automatic Refund (On Fiat Failure)

```mermaid
sequenceDiagram
    participant OfframpService
    participant Blockchain
    participant User

    Note over OfframpService: Fiat transfer failed
    OfframpService->>OfframpService: Queue Refund Job (5 min delay)
    OfframpService->>OfframpService: Status: REFUND_PENDING

    loop Refund Process (Max 3 retries)
        OfframpService->>Blockchain: Return Crypto to Sender
        alt Refund Success
            Blockchain-->>OfframpService: Crypto Returned
            OfframpService->>OfframpService: Status: REFUNDED
            OfframpService-->>User: Crypto Refunded
        else Refund Failed
            OfframpService->>OfframpService: Retry Count++
            alt Max Retries Reached
                OfframpService->>OfframpService: Status: REFUND_FAILED
                Note over OfframpService: Manual intervention required
            end
        end
    end
```

---

## 5. Webhook Notification

```mermaid
sequenceDiagram
    participant OfframpService
    participant Queue
    participant Integrator

    OfframpService->>Queue: Queue Callback Job
    Queue->>Integrator: POST Webhook (Signed)

    alt Webhook Success
        Integrator-->>Queue: 200 OK
        Queue->>OfframpService: CALLBACK_SENT
    else Webhook Failed
        Queue->>Queue: Retry 3x with Backoff
        alt Retries Exhausted
            Queue->>Queue: Cron Retry (Every 2h, Max 24h)
        end
    end
```

---

## Transaction Statuses

| Status | Description |
|--------|-------------|
| `PENDING` | Awaiting crypto payment |
| `CRYPTO_RECEIVED` | Crypto confirmed, preparing fiat transfer |
| `PROCESSING` | Fiat disbursement in progress |
| `SUCCESS` | Fiat delivered successfully |
| `FAILED` | Transaction failed |
| `REFUND_PENDING` | Refund queued (fiat failed, returning crypto) |
| `REFUNDED` | Crypto returned to sender |
| `REFUND_FAILED` | Refund attempts exhausted, manual intervention needed |
| `TIMEOUT` | Crypto not received within timeout period |

---

## Crypto Networks Supported

### EVM Chains
- **Networks**: Ethereum, Polygon, Arbitrum, Base, Optimism, Celo
- **Tokens**: USDT, USDC, DAI
- **Confirmations**: 3 blocks required

### TRON
- **Tokens**: USDT (TRC20)
- **Confirmations**: Verified via TronGrid

### Lightning Network
- **Use Case**: Fast Bitcoin offramps
- **Payment**: Lightning invoice

### Stellar
- **Tokens**: USDC, other Stellar assets
- **Confirmations**: Near-instant

---

## Key Features

### Rate Locking
- Exchange rate locked at transaction creation
- Valid for 60 seconds
- Must request new rate if expired

### Automatic Refunds
- Triggered 5 minutes after fiat transfer failure
- Up to 3 retry attempts
- Returns crypto to original sender address
- Track via `/offramp/refund-status/:referenceId`

### Flexible Wallet Options
- **External Wallet**: User controls private keys
- **Integrated Wallet**: Platform-managed for instant processing

---

## Error Handling

### Rate Expired
```json
{
  "statusCode": 400,
  "message": "Rate expired. Rates are valid for 60 seconds."
}
```

### Insufficient Crypto Amount
```json
{
  "statusCode": 400,
  "message": "Insufficient crypto amount"
}
```

### Fiat Transfer Failed (Auto-Refund)
```json
{
  "status": "REFUND_PENDING",
  "message": "Fiat transfer failed. Crypto refund will be processed in 5 minutes.",
  "refund": {
    "cryptoAmount": 10.5,
    "currency": "USDT",
    "network": "Polygon"
  }
}
```

---

## Best Practices

- **Pre-Check Rates**: Use `/rates/offramp-rate` before creating transaction
- **Validate Addresses**: Ensure sender address format matches network
- **Handle Callbacks**: Implement webhook endpoint with HMAC verification
- **Monitor Refunds**: Check refund status via `/offramp/refund-status/:referenceId`
- **Bank Transfers**: Verify bank account details before submission

---

## Testing

Use sandbox mode with test credentials provided in sandbox documentation.

**Test Scenarios**:
- Crypto amounts ending in `.00` trigger success
- Crypto amounts ending in `.99` trigger fiat failure + refund
- Crypto amounts ending in `.88` trigger timeout
